# 工单详情页功能修改计划

## 1. 关闭工单功能实现

### 功能需求
- 点击"关闭工单"按钮弹出对话框
- 对话框包含必填输入框（默认值"问题已解决"）、确认按钮、取消按钮
- 确认时调用API，传递close_reason和ticket_id
- 取消时关闭对话框

### 修改内容
- 引入Ant Design的Modal和Form组件
- 新增关闭工单对话框状态管理
- 实现关闭工单API调用逻辑
- 添加表单验证和错误处理

## 2. 图片上传功能优化

### 功能需求
- 上传图片后调用imagesUpload API
- 将返回的图片URL保存到attachments数组

### 修改内容
- 修改handleImageUpload函数，实现真实API调用
- 添加图片上传进度和状态管理
- 优化图片上传失败的错误处理

## 3. 发送消息功能优化

### 功能需求
- 根据attachments数组是否为空动态设置message_type
- 有图片：message_type: 1
- 纯文本：message_type: 0

### 修改内容
- 修改handleSendMessage函数，添加message_type动态判断逻辑
- 确保请求体中message_type正确设置

## 4. 代码修改点

### 引入新组件
- 在page.tsx中引入Modal、Form组件

### 修改现有函数
1. `handleCloseWorkOrder` - 实现对话框逻辑
2. `handleImageUpload` - 实现API调用
3. `handleSendMessage` - 动态设置message_type

### 新增状态管理
- 关闭工单对话框的显示/隐藏状态
- 关闭工单的备注内容
- 图片上传状态

## 5. API调用规范

### 关闭工单API
- URL: `/api/workOrder/closeWorkOrder`
- Method: POST
- Request Body: `{ ticket_id: number, close_reason: string }`

### 图片上传API
- URL: `/api/imagesUpload`
- Method: POST
- Request: FormData包含图片文件
- Response: 返回图片URL

### 发送消息API
- URL: `/api/workOrder/sendMessage`
- Method: POST
- Request Body: 动态设置message_type字段

## 6. 错误处理

- 关闭工单失败时显示错误信息
- 图片上传失败时显示错误信息
- 发送消息失败时显示错误信息

## 7. 测试要点

- 关闭工单功能的完整流程
- 图片上传功能的API调用
- 发送消息时message_type的正确设置
- 各种错误情况下的用户提示

## 8. 代码风格

- 保持现有代码风格一致性
- 添加必要的注释
- 确保TypeScript类型安全
- 遵循React最佳实践

以上是详细的修改计划，我将按照这个计划逐步实现各个功能。