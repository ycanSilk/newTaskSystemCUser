# Token失效处理修复计划

## 问题分析

1. **middleware.ts中的validateToken函数问题**：
   - 直接返回`response.status === 200`，没有检查响应体中的实际token有效性
   - console.log语句在return之后，永远不会执行
   - 没有正确处理token无效的情况

2. **useUser hook问题**：
   - 只在组件初始化和页面可见性变化时检查登录状态
   - 没有定期检查token有效性
   - 没有在token失效时触发重定向或提示

3. **页面组件问题**：
   - 没有正确处理API请求失败的情况
   - 没有在token失效时显示用户提示

## 修复方案

### 1. 修复middleware.ts

**修改validateToken函数**：
- 正确解析响应体，检查token有效性
- 移除无效的console.log语句
- 确保token无效时返回false

### 2. 增强useUser hook

**添加定期检查机制**：
- 添加setInterval定期检查token有效性
- 在组件卸载时清除定时器
- token失效时清除用户信息

**添加重定向逻辑**：
- 在token失效时，使用router重定向到登录页
- 添加登录过期提示

### 3. 改进页面组件错误处理

**增强错误处理**：
- 在API请求失败时，显示更友好的错误信息
- 区分token失效错误和其他错误
- token失效时自动跳转登录页

## 具体实现

### 1. 修复middleware.ts

```typescript
const validateToken = async (token: string, origin: string): Promise<boolean> => {
  try {
    const response = await fetch('/api/auth/checkToken', {
      method: 'get',
      headers: {
        'Content-Type': 'application/json',
        'X-Token': token
      },
      credentials: 'include',
      cache: 'no-store',
    });
    
    // 只有状态码为200且响应体中code为0时，才表示token有效
    if (response.status === 200) {
      const result = await response.json();
      return result.code === 0 && result.data?.valid === true;
    }
    return false;
  } catch (error) {
    return false;
  }
};
```

### 2. 增强useUser hook

```typescript
// 添加router导入
import { useRouter } from 'next/navigation';

// 在useUser函数中添加
const router = useRouter();

// 添加定期检查机制
useEffect(() => {
  // 定期检查token有效性，每30秒检查一次
  const checkInterval = setInterval(() => {
    if (!checkIfLoginPage()) {
      checkLoginStatus();
    }
  }, 30000);
  
  // 组件卸载时清除定时器
  return () => clearInterval(checkInterval);
}, [checkIfLoginPage]);

// 在checkLoginStatus函数中添加重定向逻辑
if (user) {
  setUser(user);
} else {
  clearUser();
  // token失效，重定向到登录页
  if (!checkIfLoginPage()) {
    router.push('/commenter/auth/login');
    // 可以添加登录过期提示
    // toast.error('登录已过期，请重新登录');
  }
}
```

### 3. 改进页面组件错误处理

**在hall-content/page.tsx中增强错误处理**：
- 区分token失效错误和其他错误
- token失效时自动跳转登录页
- 显示友好的错误信息

## 预期效果

1. **自动校验token**：
   - 页面加载时检查token有效性
   - 定期（每30秒）检查token有效性
   - 页面可见性变化时检查token有效性

2. **token失效处理**：
   - 清除用户信息
   - 重定向到登录页
   - 显示登录过期提示

3. **错误处理改进**：
   - 显示友好的错误信息
   - 区分不同类型的错误
   - 提供明确的用户指引

通过以上修复，当用户手动清除cookie或token失效时，系统会自动检测到token无效，并引导用户重新登录，提供良好的用户体验。